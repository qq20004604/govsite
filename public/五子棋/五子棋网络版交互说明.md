##环境

1. 服务器端使用Nodejs6.9.4 + Express4.x + Socket.IO 2.02
2. 客户端使用socket.io.js

##名词和变量

游戏大厅

```
1. 建立连接后就认为在游戏大厅中；
2. 断开连接（比如关闭浏览器或者其他），认为离开游戏大厅；
3. 即使在【游戏房间】中，也依然认定其在游戏大厅；
4. 通过服务器端onlineUsers（Map结构）来存储在线用户（作为key）；
```

游戏房间

```
1. 创建游戏后，创建的内容就是游戏房间；
2. 游戏房间变量存储以下内容：
2.1 玩家player存储黑方black，白方white；
2.2 观战者watcher（Set结构）；
2.3 房间创建时间ctime（Number类型）；
2.4 下棋数据steps（Array）；
2.5 棋盘大小size（Number）；
2.6 游戏结束标志gameover（Boolean）；
2.7 游戏房间的编号gameID（Number）；
```

在线用户onlineUsers（服务器端）

```
1. 以userSocket作为key，存储在线用户，以及该用户当前的游戏信息（房间号 + 角色）；
2. 用户建立连接时，将其加入；
3. 用户退出房间时，从中删除（并找到其对应的游戏房间，从房间删除），通报该房间所有人；
4. 退出游戏大厅时，读取到该用户所在游戏信息。如果有则调用3
5. Map结构；
6. key是userSocket；
7. value是对象；
7.1 属性id是游戏ID；
7.2 属性role是游戏角色；
```

开启的房间gamelist（服务器端）

```
1. Map结构，以gameID作为key，存储该房间的信息；
2. 游戏房间的具体数据查看关键词【游戏房间】；
3. 可以通过.size获取到当前已开启的游戏房间的房间数
```


##建立长连接connection

1. 用户建立创长连接，回调函数出现socket变量；
2. 将socket作为key，存储在onlineUsers中，值为null；



##退出长连接disconnect

1. 用户退出长连接，触发"disconnect"；
2. 调用【退出游戏房间】相关逻辑；


##创建游戏房间createGame

1. 检查该用户是否在房间中，如果在则禁止创建；
1. 随机创建一个不重复的房间ID；
2. 初始化该房间信息；
3. 将该房间信息和房间ID，以kv形式添加到gamelist中；
4. 返回该房间ID；
5. 调用加入房间的API；（见下面）

##加入房间userEnterGame

1. 需要参数gameID，userSocket（用户的socket），role（黑方、白方或者观战，无参数时默认为观战）；
2. 首先通过userSocket去查onlineUsers，看是否有值；
3. 如果有值，则调用【退出游戏房间】相关逻辑；
4. 从gameID查看gamelist，是否有该房间；
5. 如果查不到则通知用户该房间不存在，返回；
6. 如果找到该房间，首先检查是否有role，如果没有，则将其设置为watcher（观战）；
7. 检查该房间指定role是否有人，如果有人，则将用户添加到watcher位置，并通报用户该位置有人；
8. 如果没有人，则将用户添加到该位置；
9. 更新该角色的onlineUser中的值（{gameID, role}）；
10. 通报该房间内所有用户，有玩家进入，其角色为role；
11. 通过gameID从list里拉取信息，然后对该房间内所有用户，调用【向用户更新房间信息】逻辑；

##退出游戏房间leaveGame

1. 需要参数userSocket；
2. 以socket作为key，尝试从onlineUsers拉取值；
3. 如果值不为空，可以从其数据中拉取到房间ID和游戏角色；
4. 从gamelist拉取到该游戏，删除该角色；
5. 对该游戏房间中所有玩家，通报该玩家已经退出游戏；
6. 从onlineUsers删除该用户；
7. 如果notLeave不为true，对该房间内所有用户，调用【向用户更新房间信息】逻辑；

##将某人踢出游戏房间kickGame（不做）

1. 先从发起方，拉取他的socket；
2. 从socket拉取到gameID；
3. 从gameID拉取到房间；
4. 从发起方拉取到踢人的位置；
5. 删除该角色；
6. 对该游戏房间中所有玩家，通报该玩家被踢出游戏；
7. 对该角色通报他被踢出游戏；
8. 更新该角色的onlineUser中的值（null）；

##切换游戏角色changeGameRole

1. 需要参数userSocket和role；
2. 从userSocket获游戏ID和游戏角色currentRole；
3. 去gamelist找该房间，如果房间不存在则提示，并return（理论上不可能吧？但为了代码健壮性写上）；
4. 找确定该房间该位置是否有人，如果有人则提示，并return；
5. 将当前用户添加到该位置；
6. 从之前获取的角色位置，在游戏房间中找到，并删除该userSocket；
7. 更新该角色的onlineUser中的值（当前有gameID和role）；
8. 向房间内所有用户，通报该用户角色切换；


##向用户更新房间信息updateGameRoom

1. 需要参数gameID；
2. 从gamelist拉取当前游戏房间用户的信息；
3. 创建对象，里面添加进去黑方白方和观战者的信息；
4. 遍历游戏房间的黑方、白方和观战方的userSocket，并向他们emit第三步的对象，emit的key是updateGameRoom；



##【函数】通过gameID向游戏内所有用户发送通知信息alertToRoom

1. 当然需要参数gameID，需要参数信息内容；
2. 通过gameID去从gamelist里找游戏；
3. 遍历游戏里的每个人，调用emit发送信息，key是alertToRoom；

##【函数】通过game去遍历每个用户forEachUserSocketInGame

1. 参数是从gamelist里找到的game，以及回调函数；
2. 遍历每个角色，调用回调函数。回调函数参数一是该位置的userSocket，参数二是role


##【消息key】通报给当前用户alertToUser

1. 参数是对象，{msg:""}